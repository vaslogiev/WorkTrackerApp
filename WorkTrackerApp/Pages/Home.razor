@page "/"
@using System.Globalization
@using Supabase
@using Postgrest.Attributes
@using Postgrest.Models
@inject Supabase.Client SupabaseClient

<div class="app-container">
  @* СЕКЦИЯ ЗА СТАВКИ *@
  <div class="card shadow-sm p-3 mb-3 border-0 bg-light">
    <h6 class="mb-3 fw-bold">Настройки на ставките</h6>
    <div class="row g-2">
      <div class="col-6">
        <label class="small text-muted">Пълна (Изработен)</label>
        <div class="input-group input-group-sm">
          <input type="number" class="form-control" @bind="rateFull">
          <span class="input-group-text">лв</span>
        </div>
      </div>
      <div class="col-6">
        <label class="small text-muted">Частична (Платен)</label>
        <div class="input-group input-group-sm">
          <input type="number" class="form-control" @bind="ratePart">
          <span class="input-group-text">лв</span>
        </div>
      </div>
    </div>
    <button class="btn btn-sm btn-dark mt-2 w-100" @onclick="SaveRates" disabled="@isSavingRates">
      @(isSavingRates ? "Запис..." : "Запази ставките в базата")
    </button>
  </div>

  @if (isLoading)
  {
    <div class="text-center my-5"><div class="spinner-border text-primary"></div></div>
  }
  else
  {
    <div class="calendar-card card shadow-sm p-3 mb-4">
      <div class="calendar-nav d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-outline-primary btn-sm" @onclick="() => ChangeMonth(-1)">⬅</button>
        <h5 class="mb-0 text-capitalize">@viewDate.ToString("MMMM yyyy", new CultureInfo("bg-BG"))</h5>
        <button class="btn btn-outline-primary btn-sm" @onclick="() => ChangeMonth(1)">➡</button>
      </div>

      <div class="calendar-grid">
        @foreach (var day in new[] { "Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Нд" })
        {
          <div class="header">@day</div>
        }
        @for (int i = 0; i < OffsetDays; i++)
        {
          <div class="empty"></div>
        }
        @foreach (var date in MonthDates)
        {
          <div class="day @GetStatusClass(date) @(SelectedDates.Contains(date) ? "selected" : "")"
               @onclick="() => ToggleSelection(date)">
            @date.Day
          </div>
        }
      </div>
    </div>

    <div class="actions d-grid gap-2 mb-4">
      <div class="btn-group w-100">
        <button class="btn btn-warning" @onclick="() => SetStatusForSelected(1)">Изработен</button>
        <button class="btn btn-success" @onclick="() => SetStatusForSelected(2)">Платен</button>
        <button class="btn btn-secondary" @onclick="() => SetStatusForSelected(3)">Приключен</button>
      </div>
      <button class="btn btn-outline-danger btn-sm" @onclick="() => SetStatusForSelected(0)">Изчисти избраните</button>
    </div>

    <div class="stats card p-3 mb-4 bg-primary text-white border-0 shadow-sm">
      <div class="d-flex justify-content-between align-items-center">
        <span>Общо за месеца:</span>
        <span class="h4 mb-0">@CalculateTotal() лв.</span>
      </div>
    </div>

    <button class="btn btn-primary w-100 py-3 shadow" @onclick="SyncDays" disabled="@isSyncing">
      @(isSyncing ? "Синхронизиране..." : "ЗАПАЗИ ДНИТЕ В ОБЛАКА")
    </button>
    <p class="text-center mt-2 small text-muted">@syncMessage</p>
  }
</div>

<style>
  ::deep .sidebar, ::deep .top-row {
    display: none !important;
  }

  .app-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 15px;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }

  .day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #eee;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
  }

  .header {
    font-size: 0.75rem;
    text-align: center;
    color: #888;
    padding-bottom: 5px;
  }

  .status-worked {
    background: #ffeb3b;
    border-color: #fdd835;
  }

  .status-paid {
    background: #4caf50;
    color: white;
    border-color: #43a047;
  }

  .status-finished {
    background: #e0e0e0;
    border-color: #bdbdbd;
  }

  .selected {
    outline: 3px solid #0d6efd;
    outline-offset: -3px;
  }

  .empty {
    border: none;
  }
</style>

@code {
  [Table("work_days")]
  public class DayEntry : BaseModel
  {
    [PrimaryKey("date", false)][Column("date")] public DateTime Date { get; set; }
    [Column("status")] public int StatusInt { get; set; }
  }

  [Table("settings")]
  public class SettingEntry : BaseModel
  {
    [PrimaryKey("key", false)][Column("key")] public string Key { get; set; } = "";
    [Column("value")] public decimal Value { get; set; }
  }

  private List<DayEntry> cloudDays = new();
  private HashSet<DateTime> SelectedDates = new();
  private List<DateTime> MonthDates = new();
  private DateTime viewDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
  private int OffsetDays;

  private decimal rateFull = 140;
  private decimal ratePart = 90;

  private bool isLoading = true, isSyncing = false, isSavingRates = false;
  private string syncMessage = "";

  protected override async Task OnInitializedAsync()
  {
    await LoadRates();
    await LoadDays();
    SetupCalendar();
  }

  private void SetupCalendar()
  {
    MonthDates.Clear();
    OffsetDays = ((int)viewDate.DayOfWeek + 6) % 7;
    for (int i = 1; i <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); i++)
      MonthDates.Add(new DateTime(viewDate.Year, viewDate.Month, i));
  }

  private void ChangeMonth(int step) { viewDate = viewDate.AddMonths(step); SetupCalendar(); }

  private async Task LoadRates()
  {
    try
    {
      var response = await SupabaseClient.From<SettingEntry>().Get();
      var full = response.Models.FirstOrDefault(m => m.Key == "rate_full");
      if (full != null) rateFull = full.Value;
      var part = response.Models.FirstOrDefault(m => m.Key == "rate_part");
      if (part != null) ratePart = part.Value;
    }
    catch { }
  }

  private async Task SaveRates()
  {
    isSavingRates = true;
    try
    {
      await SupabaseClient.From<SettingEntry>().Upsert(new SettingEntry { Key = "rate_full", Value = rateFull });
      await SupabaseClient.From<SettingEntry>().Upsert(new SettingEntry { Key = "rate_part", Value = ratePart });
      syncMessage = "Ставките са запазени!";
    }
    catch { syncMessage = "Грешка при ставките"; }
    finally { isSavingRates = false; StateHasChanged(); }
  }

  private async Task LoadDays()
  {
    isLoading = true;
    try
    {
      var response = await SupabaseClient.From<DayEntry>().Get();
      // Хак за датата +1 ден заради UTC отместването
      cloudDays = response.Models.Select(d => { d.Date = d.Date.AddDays(1).Date; return d; }).ToList();
    }
    catch { }
    finally { isLoading = false; StateHasChanged(); }
  }

  private decimal CalculateTotal()
  {
    var workedDays = cloudDays.Count(d => d.Date.Month == viewDate.Month && d.Date.Year == viewDate.Year && d.StatusInt == 1);
    var paidDays = cloudDays.Count(d => d.Date.Month == viewDate.Month && d.Date.Year == viewDate.Year && d.StatusInt == 2);
    return (workedDays * rateFull) + (paidDays * ratePart);
  }

  private void ToggleSelection(DateTime date) { if (!SelectedDates.Remove(date)) SelectedDates.Add(date); }

  private async Task SetStatusForSelected(int newStatus)
  {
    foreach (var date in SelectedDates)
    {
      var existing = cloudDays.FirstOrDefault(d => d.Date.Date == date.Date);
      if (newStatus == 0) { if (existing != null) cloudDays.Remove(existing); }
      else
      {
        if (existing != null) existing.StatusInt = newStatus;
        else cloudDays.Add(new DayEntry { Date = date.Date, StatusInt = newStatus });
      }
    }
    SelectedDates.Clear();
    StateHasChanged();
  }

  private async Task SyncDays()
  {
    isSyncing = true;
    syncMessage = "Записване на дни...";
    try
    {
      await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.NotEqual, "1900-01-01").Delete();
      if (cloudDays.Any()) await SupabaseClient.From<DayEntry>().Insert(cloudDays);
      syncMessage = "✅ Всичко е синхронизирано!";
    }
    catch { syncMessage = "❌ Грешка при запис"; }
    finally { isSyncing = false; StateHasChanged(); }
  }

  private string GetStatusClass(DateTime date) =>
      cloudDays.FirstOrDefault(d => d.Date.Date == date.Date)?.StatusInt switch
      {
        1 => "status-worked",
        2 => "status-paid",
        3 => "status-finished",
        _ => ""
      };
}