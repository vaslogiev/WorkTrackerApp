@page "/"
@using System.Globalization
@using Supabase
@using Postgrest.Attributes
@using Postgrest.Models
@using System.Runtime.Serialization
@inject Supabase.Client SupabaseClient

<div class="container mt-3" style="max-width: 600px;">
  @* DEBUG ЛЕНТА - показва точно какво подава календарът *@
  <div class="alert alert-info small py-1 mb-2">
    <strong>UI Дата:</strong> @lastClickedDate | <strong>Брой избрани:</strong> @SelectedDates.Count
  </div>

  @if (isLoading)
  {
    <div class="text-center my-5"><div class="spinner-border text-primary"></div></div>
  }
  else
  {
    <div class="calendar-container card shadow-sm p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-outline-primary" @onclick="() => ChangeMonth(-1)">⬅</button>
        <h4 class="mb-0 text-capitalize">@viewDate.ToString("MMMM yyyy", new CultureInfo("bg-BG"))</h4>
        <button class="btn btn-sm btn-outline-primary" @onclick="() => ChangeMonth(1)">➡</button>
      </div>

      <div class="calendar-grid">
        @foreach (var dayName in new[] { "Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Нд" })
        {
          <div class="weekday-header">@dayName</div>
        }

        @for (int i = 0; i < OffsetDays; i++)
        {
          <div class="calendar-day empty"></div>
        }

        @foreach (var dateStr in MonthDatesStrings)
        {
          <div class="calendar-day @GetStatusClass(dateStr) @(SelectedDates.Contains(dateStr) ? "selected" : "")"
               @onclick='() => ToggleSelection(dateStr)'>
            @dateStr.Split('-')[2]
          </div>
        }
      </div>
    </div>

    <div class="card shadow-sm p-3 border-0 bg-white mb-4 text-center">
      <div class="btn-group w-100">
        <button class="btn btn-warning" @onclick="() => SetStatusForSelected(1)">Изработен</button>
        <button class="btn btn-success" @onclick="() => SetStatusForSelected(2)">Платен</button>
        <button class="btn btn-secondary" @onclick="() => SetStatusForSelected(3)">Приключен</button>
      </div>
      <button class="btn btn-outline-danger btn-sm mt-2" @onclick="() => SetStatusForSelected(0)">Изчисти избраните</button>
    </div>

    <button class="btn btn-primary w-100 py-3 shadow-sm" @onclick="SyncData" disabled="@isSyncing">
      @(isSyncing ? "Синхронизиране..." : "Синхронизирай всичко")
    </button>
    <p class="text-center mt-2 small">@syncMessage</p>
  }
</div>

<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }

  .calendar-day {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #f0f0f0;
    border-radius: 6px;
    cursor: pointer;
  }

  .status-worked {
    background-color: #ffeb3b;
  }

  .status-paid {
    background-color: #4caf50;
    color: white;
  }

  .status-finished {
    background-color: #dee2e6;
  }

  .selected {
    outline: 3px solid #0d6efd;
  }

  .empty {
    border: none;
  }

  .sidebar, .top-row {
    display: none !important;
  }

  .main {
    width: 100% !important;
  }
</style>

@code {
  [Table("work_days")]
  public class DayEntry : BaseModel
  {
    [PrimaryKey("date", false)]
    [Column("date")]
    public DateTime Date { get; set; } // Връщаме го на DateTime, но с "буфер"

    [Column("status")]
    public int StatusInt { get; set; }
  }

  private List<DayEntry> cloudDays = new();
  private HashSet<DateTime> SelectedDates = new();
  private List<DateTime> MonthDates = new(); // Работим с обекти за UI
  private DateTime viewDate = DateTime.Now;
  private int OffsetDays;
  private bool isLoading = true;
  private bool isSyncing = false;
  private string syncMessage = "";
  private string lastClickedDate = "";

  protected override async Task OnInitializedAsync() { await LoadDataFromCloud(); SetupCalendar(); }

  private void SetupCalendar()
  {
    MonthDates.Clear();
    var firstDay = new DateTime(viewDate.Year, viewDate.Month, 1);
    OffsetDays = ((int)firstDay.DayOfWeek + 6) % 7;

    for (int i = 1; i <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); i++)
    {
      // КЛЮЧЪТ: Генерираме датата точно в 12:00:00 на обяд.
      // Така дори -2 часа отместване ще даде 10:00:00 СЪЩИЯ ДЕН.
      var d = new DateTime(viewDate.Year, viewDate.Month, i, 12, 0, 0, DateTimeKind.Utc);
      MonthDates.Add(d);
    }
  }

  private void ChangeMonth(int step) { viewDate = viewDate.AddMonths(step); SetupCalendar(); }

  private async Task LoadDataFromCloud()
  {
    isLoading = true;
    try
    {
      var response = await SupabaseClient.From<DayEntry>().Get();
      // Когато зареждаме, нормализираме всичко към обяд, за да съвпадат
      cloudDays = response.Models.Select(d =>
      {
        d.Date = new DateTime(d.Date.Year, d.Date.Month, d.Date.Day, 12, 0, 0, DateTimeKind.Utc);
        return d;
      }).ToList();
    }
    catch (Exception) { }
    finally { isLoading = false; StateHasChanged(); }
  }

  private void ToggleSelection(DateTime date)
  {
    lastClickedDate = date.ToString("yyyy-MM-dd");
    // Сравняваме само дата
    var existing = SelectedDates.FirstOrDefault(d => d.Date == date.Date);
    if (existing != default) SelectedDates.Remove(existing);
    else SelectedDates.Add(date);
  }

  private async Task SetStatusForSelected(int newStatus)
  {
    foreach (var date in SelectedDates)
    {
      var targetDate = new DateTime(date.Year, date.Month, date.Day, 12, 0, 0, DateTimeKind.Utc);
      var existing = cloudDays.FirstOrDefault(d => d.Date.Date == targetDate.Date);

      if (newStatus == 0)
      {
        if (existing != null)
        {
          cloudDays.Remove(existing);
          await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.Equals, targetDate.ToString("yyyy-MM-dd")).Delete();
        }
      }
      else
      {
        var day = new DayEntry { Date = targetDate, StatusInt = newStatus };
        if (existing != null) cloudDays.Remove(existing);
        cloudDays.Add(day);
        await SupabaseClient.From<DayEntry>().Upsert(day);
      }
    }
    SelectedDates.Clear();
    StateHasChanged();
  }

  private async Task SyncData()
  {
    isSyncing = true;
    syncMessage = "Синхронизиране...";
    try
    {
      await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.NotEqual, "1900-01-01").Delete();
      if (cloudDays.Any())
      {
        await SupabaseClient.From<DayEntry>().Insert(cloudDays);
        syncMessage = "Успешно!";
      }
    }
    catch (Exception) { syncMessage = "Грешка"; }
    finally { isSyncing = false; StateHasChanged(); }
  }

  private string GetStatusClass(DateTime date) =>
      cloudDays.FirstOrDefault(d => d.Date.Date == date.Date)?.StatusInt switch
      {
        1 => "status-worked",
        2 => "status-paid",
        3 => "status-finished",
        _ => "status-none"
      };
}