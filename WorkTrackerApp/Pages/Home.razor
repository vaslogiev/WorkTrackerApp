@page "/"
@using System.Globalization
@using Supabase
@using Postgrest.Attributes
@using Postgrest.Models
@using System.Runtime.Serialization
@inject Supabase.Client SupabaseClient

<div class="container mt-3" style="max-width: 600px;">
  @* DEBUG ЛЕНТА - показва какво реално се случва *@
  <div class="alert alert-info small py-1 mb-2">
    <strong>Последно кликнато:</strong> @lastClickedDate | <strong>Избрани:</strong> @SelectedDates.Count
  </div>

  @if (isLoading)
  {
    <div class="text-center my-5"><div class="spinner-border text-primary"></div></div>
  }
  else
  {
    <div class="calendar-container card shadow-sm p-3 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-outline-primary" @onclick="() => ChangeMonth(-1)">⬅</button>
        <h4 class="mb-0 text-capitalize">@viewDate.ToString("MMMM yyyy", new CultureInfo("bg-BG"))</h4>
        <button class="btn btn-sm btn-outline-primary" @onclick="() => ChangeMonth(1)">➡</button>
      </div>

      <div class="calendar-grid">
        @foreach (var dayName in new[] { "Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Нд" })
        {
          <div class="weekday-header">@dayName</div>
        }

        @for (int i = 0; i < OffsetDays; i++)
        {
          <div class="calendar-day empty"></div>
        }

        @foreach (var date in MonthDates)
        {
          <div class="calendar-day @GetStatusClass(date) @(SelectedDates.Any(d => d.Date == date.Date) ? "selected" : "")"
               @onclick='() => ToggleSelection(date)'>
            @date.Day
          </div>
        }
      </div>
    </div>

    <div class="card shadow-sm p-3 border-0 bg-white mb-4 text-center">
      <div class="btn-group w-100">
        <button class="btn btn-warning" @onclick="() => SetStatusForSelected(1)">Изработен</button>
        <button class="btn btn-success" @onclick="() => SetStatusForSelected(2)">Платен</button>
        <button class="btn btn-secondary" @onclick="() => SetStatusForSelected(3)">Приключен</button>
      </div>
      <button class="btn btn-outline-danger btn-sm mt-2" @onclick="() => SetStatusForSelected(0)">Изчисти избраните</button>
    </div>

    <button class="btn btn-primary w-100 py-3 shadow-sm" @onclick="SyncData" disabled="@isSyncing">
      @(isSyncing ? "Синхронизиране..." : "Синхронизирай всичко")
    </button>
    <p class="text-center mt-2 small">@syncMessage</p>
  }
</div>

<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
  }

  .calendar-day {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #f0f0f0;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s;
  }

  .status-worked {
    background-color: #ffeb3b !important;
  }

  .status-paid {
    background-color: #4caf50 !important;
    color: white;
  }

  .status-finished {
    background-color: #dee2e6 !important;
  }

  .selected {
    outline: 3px solid #0d6efd;
    z-index: 10;
  }

  .empty {
    border: none;
  }

  .weekday-header {
    text-align: center;
    font-weight: bold;
    font-size: 0.8rem;
    color: #666;
  }

  /* Smartphone UI Fix: Скриваме навигацията директно тук */
  .sidebar, .top-row {
    display: none !important;
  }

  .page {
    display: block !important;
  }

  main {
    width: 100% !important;
  }

  .content {
    padding: 10px !important;
  }
</style>

@code {
  [Table("work_days")]
  public class DayEntry : BaseModel
  {
    [PrimaryKey("date", false)]
    [Column("date")]
    public DateTime Date { get; set; }

    [Column("status")]
    public int StatusInt { get; set; }
  }

  private List<DayEntry> cloudDays = new();
  private HashSet<DateTime> SelectedDates = new();
  private List<DateTime> MonthDates = new();
  private DateTime viewDate = DateTime.Now;
  private int OffsetDays;
  private bool isLoading = true;
  private bool isSyncing = false;
  private string syncMessage = "";
  private string lastClickedDate = "";

  protected override async Task OnInitializedAsync() { await LoadDataFromCloud(); SetupCalendar(); }

  private void SetupCalendar()
  {
    MonthDates.Clear();
    var firstDay = new DateTime(viewDate.Year, viewDate.Month, 1);
    OffsetDays = ((int)firstDay.DayOfWeek + 6) % 7;
    for (int i = 1; i <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); i++)
    {
      // ФИКС: Слагаме 12:00 на обяд, за да не прескача деня при UTC конверсия
      MonthDates.Add(new DateTime(viewDate.Year, viewDate.Month, i, 12, 0, 0, DateTimeKind.Utc));
    }
  }

  private void ChangeMonth(int step)
  {
    viewDate = viewDate.AddMonths(step);
    SetupCalendar();
  }

  private async Task LoadDataFromCloud()
  {
    isLoading = true;
    try
    {
      var response = await SupabaseClient.From<DayEntry>().Get();
      cloudDays = response.Models;
    }
    catch (Exception) { }
    finally { isLoading = false; StateHasChanged(); }
  }

  private void ToggleSelection(DateTime date)
  {
    lastClickedDate = date.ToString("yyyy-MM-dd");
    // Сравняваме само Date компонента за по-сигурно
    var existing = SelectedDates.FirstOrDefault(d => d.Date == date.Date);
    if (existing != default) SelectedDates.Remove(existing);
    else SelectedDates.Add(date);
  }

  private async Task SetStatusForSelected(int newStatus)
  {
    foreach (var date in SelectedDates)
    {
      var targetDate = new DateTime(date.Year, date.Month, date.Day, 12, 0, 0, DateTimeKind.Utc);
      var existing = cloudDays.FirstOrDefault(d => d.Date.Date == targetDate.Date);

      if (newStatus == 0)
      {
        if (existing != null)
        {
          cloudDays.Remove(existing);
          try { await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.Equals, targetDate.ToString("yyyy-MM-dd")).Delete(); } catch { }
        }
      }
      else
      {
        var day = new DayEntry { Date = targetDate, StatusInt = newStatus };
        if (existing != null) cloudDays.Remove(existing);
        cloudDays.Add(day);
        try { await SupabaseClient.From<DayEntry>().Upsert(day); } catch { }
      }
    }
    SelectedDates.Clear();
    StateHasChanged();
  }

  private async Task SyncData()
  {
    isSyncing = true;
    syncMessage = "Синхронизиране...";
    try
    {
      await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.NotEqual, "1900-01-01").Delete();
      if (cloudDays.Any())
      {
        await SupabaseClient.From<DayEntry>().Insert(cloudDays);
        syncMessage = "Успешно синхронизирано!";
      }
    }
    catch (Exception) { syncMessage = "Грешка при запис"; }
    finally { isSyncing = false; StateHasChanged(); }
  }

  private string GetStatusClass(DateTime date) =>
      cloudDays.FirstOrDefault(d => d.Date.Date == date.Date)?.StatusInt switch
      {
        1 => "status-worked",
        2 => "status-paid",
        3 => "status-finished",
        _ => "status-none"
      };
}