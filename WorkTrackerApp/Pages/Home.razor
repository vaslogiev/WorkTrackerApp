@page "/"
@using System.Globalization
@using Supabase
@using Supabase.Interfaces
@using Postgrest.Attributes
@using Postgrest.Models
@inject Supabase.Client SupabaseClient

<div class="mobile-container">
  @* 1. СЕКЦИЯ СУМИ - Видима само за ADMIN *@
  @if (isAdmin)
  {
    <div class="stats-grid mb-3">
      <div class="stat-card payment">
        <span class="stat-label">За плащане</span>
        <span class="stat-value">@CalculateForPayment()</span>
        <span class="stat-sub">@CountWorked() дни</span>
      </div>
      <div class="stat-card receiving">
        <span class="stat-label">За получаване</span>
        <span class="stat-value">@CalculateToReceive()</span>
        <span class="stat-sub">@CountNotFinished() дни</span>
      </div>
    </div>
  }

  @* 2. КАЛЕНДАР *@
  @if (isLoading)
  {
    <div class="text-center my-4"><div class="spinner-border text-primary"></div></div>
  }
  else
  {
    <div class="calendar-card shadow-sm mb-3">
      <div class="calendar-nav d-flex justify-content-between align-items-center mb-2">
        <button class="nav-btn" @onclick="() => ChangeMonth(-1)">❮</button>
        <span class="month-name">@viewDate.ToString("MMMM yyyy", new CultureInfo("bg-BG"))</span>
        <button class="nav-btn" @onclick="() => ChangeMonth(1)">❯</button>
      </div>

      <div class="calendar-grid">
        @foreach (var day in new[] { "П", "В", "С", "Ч", "П", "С", "Н" })
        {
          <div class="weekday">@day</div>
        }
        @for (int i = 0; i < OffsetDays; i++)
        {
          <div class="empty"></div>
        }
        @foreach (var date in MonthDates)
        {
          <div class="day @GetStatusClass(date) @(SelectedDates.Contains(date) ? "is-selected" : "") @(date.Date == DateTime.Today ? "is-today" : "")"
               @onclick="() => { if(isAdmin) ToggleSelection(date); }">
            @date.Day
          </div>
        }
      </div>
    </div>

    @* 3. БУТОНИ ЗА ОТБЕЛЯЗВАНЕ *@
    <div class="action-grid mb-3">
      <button class="act-btn worked" disabled="@(!isAdmin)" @onclick="() => SetStatusForSelected(1)">Изработен</button>
      <button class="act-btn paid" disabled="@(!isAdmin)" @onclick="() => SetStatusForSelected(2)">Платен</button>
      <button class="act-btn on-work" disabled="@(!isAdmin)" @onclick="() => SetStatusForSelected(4)">На работа</button>
      <button class="act-btn done" disabled="@(!isAdmin)" @onclick="() => SetStatusForSelected(3)">Приключен</button>
      <button class="act-btn clear w-100" style="grid-column: span 2;" disabled="@(!isAdmin)" @onclick="() => SetStatusForSelected(0)">Изчисти</button>
    </div>

    @if (isAdmin)
    {
      <button class="btn btn-primary w-100 py-3 mb-4 shadow-sm fw-bold" @onclick="SyncDays" disabled="@isSyncing">
        @(isSyncing ? "СИНХРОНИЗИРАНЕ..." : "ЗАПАЗИ ПРОМЕНИТЕ")
      </button>

      <div class="settings-card p-3 mb-3">
        <h6 class="fw-bold mb-3">Настройки на ставките</h6>
        <div class="row g-2">
          <div class="col-6">
            <label class="x-small">Пълна ставка</label>
            <input type="number" class="form-control" @bind="rateFull">
          </div>
          <div class="col-6">
            <label class="x-small">Частична ставка</label>
            <input type="number" class="form-control" @bind="ratePart">
          </div>
        </div>
        <button class="btn btn-sm btn-outline-dark mt-3 w-100" @onclick="SaveRates">Запази ставките</button>
        <button class="btn btn-link btn-sm w-100 mt-2 text-danger" @onclick="HandleLogout">Изход от Admin</button>
      </div>
    }
    else
    {
      <div class="login-section p-3 border-top mt-4">
        <h6 class="text-center mb-3 text-muted">Вход за администратор</h6>
        <div class="mb-2">
          <input type="email" class="form-control" placeholder="Вашият имейл" @bind="loginEmail" />
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" placeholder="Парола" @bind="loginPass" />
        </div>
        <button class="btn btn-dark w-100" @onclick="HandleLogin" disabled="@isLoggingIn">
          @(isLoggingIn ? "Проверка..." : "Вход")
        </button>
        @if (!string.IsNullOrEmpty(loginError))
        {
          <p class="text-danger small text-center mt-2">@loginError</p>
        }
      </div>
    }

    <p class="text-center mt-2 x-small text-muted">@syncMessage</p>
  }
</div>

<style>
  ::deep .sidebar, ::deep .top-row {
    display: none !important;
  }

  .mobile-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 10px;
    background: #f8f9fa;
    min-height: 100vh;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .stat-card {
    padding: 12px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    color: white;
  }

  .payment {
    background: #ffeb3b;
    color: #000;
  }

  .receiving {
    background: #0d6efd;
    color: white;
  }

  .calendar-card {
    background: white;
    border-radius: 15px;
    padding: 15px;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 0.9rem;
    border: 1px solid #f0f0f0;
  }

  .is-today {
    font-weight: 900 !important;
    border: 2px solid #212529 !important;
  }

  .status-worked {
    background: #ffeb3b;
  }

  .status-onwork {
    background: #f0f0f0;
    color: #666;
  }

  .status-paid {
    background: #0d6efd;
    color: white;
  }

  .status-finished {
    background: #28a745;
    color: white;
  }

  .is-selected {
    outline: 3px solid #0d6efd;
    outline-offset: -3px;
  }

  .action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .act-btn {
    padding: 15px 5px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    font-size: 0.85rem;
  }

    .act-btn:disabled {
      opacity: 0.6;
      grayscale: 1;
    }

  .worked {
    background: #ffeb3b;
  }

  .paid {
    background: #0d6efd;
    color: white;
  }

  .on-work {
    background: #f0f0f0;
    color: #666;
  }

  .done {
    background: #28a745;
    color: white;
  }

  .clear {
    background: #f8d7da;
    color: #721c24;
  }

  .login-section {
    background: #fff;
    border-radius: 15px 15px 0 0;
  }
</style>

@code {
  [Table("work_days")]
  public class DayEntry : BaseModel
  {
    [PrimaryKey("date", false)][Column("date")] public DateTime Date { get; set; }
    [Column("status")] public int StatusInt { get; set; }
  }
  [Table("settings")]
  public class SettingEntry : BaseModel
  {
    [PrimaryKey("key", false)][Column("key")] public string Key { get; set; } = "";
    [Column("value")] public decimal Value { get; set; }
  }

  private List<DayEntry> cloudDays = new();
  private HashSet<DateTime> SelectedDates = new();
  private List<DateTime> MonthDates = new();
  private DateTime viewDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
  private int OffsetDays;
  private decimal rateFull = 140, ratePart = 90;

  private bool isLoading = true, isSyncing = false, isAdmin = false, isLoggingIn = false;
  private string syncMessage = "", loginEmail = "", loginPass = "", loginError = "";

  protected override async Task OnInitializedAsync()
  {
    // Проверка за активна сесия
    isAdmin = SupabaseClient.Auth.CurrentSession != null;

    await LoadRates();
    await LoadDays();
    SetupCalendar();
  }

  private async Task HandleLogin()
  {
    if (string.IsNullOrEmpty(loginEmail) || string.IsNullOrEmpty(loginPass)) return;
    isLoggingIn = true;
    loginError = "";
    try
    {
      var session = await SupabaseClient.Auth.SignIn(loginEmail, loginPass);
      if (session != null)
      {
        isAdmin = true;
        loginEmail = ""; loginPass = "";
      }
    }
    catch (Exception ex)
    {
      // Ако не е потвърден имейла, Supabase ще хвърли грешка тук
      loginError = "Грешен имейл, парола или непотвърден акаунт!";
    }
    finally
    {
      isLoggingIn = false;
      StateHasChanged();
    }
  }

  private async Task HandleLogout()
  {
    await SupabaseClient.Auth.SignOut();
    isAdmin = false;
    StateHasChanged();
  }

  private void SetupCalendar()
  {
    MonthDates.Clear();
    OffsetDays = ((int)viewDate.DayOfWeek + 6) % 7;
    for (int i = 1; i <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); i++)
      MonthDates.Add(new DateTime(viewDate.Year, viewDate.Month, i));
  }

  private void ChangeMonth(int step) { viewDate = viewDate.AddMonths(step); SetupCalendar(); }

  private async Task LoadRates()
  {
    try
    {
      var response = await SupabaseClient.From<SettingEntry>().Get();
      var f = response.Models.FirstOrDefault(m => m.Key == "rate_full"); if (f != null) rateFull = f.Value;
      var p = response.Models.FirstOrDefault(m => m.Key == "rate_part"); if (p != null) ratePart = p.Value;
    }
    catch { }
  }

  private async Task SaveRates()
  {
    if (!isAdmin) return;
    try
    {
      await SupabaseClient.From<SettingEntry>().Upsert(new SettingEntry { Key = "rate_full", Value = rateFull });
      await SupabaseClient.From<SettingEntry>().Upsert(new SettingEntry { Key = "rate_part", Value = ratePart });
      syncMessage = "Ставките са запазени!";
    }
    catch { syncMessage = "Грешка при запис!"; }
  }

  private async Task LoadDays()
  {
    isLoading = true;
    try
    {
      var response = await SupabaseClient.From<DayEntry>().Get();
      cloudDays = response.Models.Select(d => { d.Date = d.Date.AddDays(1).Date; return d; }).ToList();
    }
    catch { }
    finally { isLoading = false; StateHasChanged(); }
  }

  private decimal CalculateForPayment() => cloudDays.Count(d => d.StatusInt == 1) * ratePart;
  private decimal CalculateToReceive() => cloudDays.Count(d => (d.StatusInt == 1 || d.StatusInt == 2)) * rateFull;
  private int CountWorked() => cloudDays.Count(d => d.StatusInt == 1);
  private int CountNotFinished() => cloudDays.Count(d => (d.StatusInt == 1 || d.StatusInt == 2));

  private void ToggleSelection(DateTime date) { if (!SelectedDates.Remove(date)) SelectedDates.Add(date); }

  private async Task SetStatusForSelected(int newStatus)
  {
    if (!isAdmin) return;
    foreach (var date in SelectedDates)
    {
      var existing = cloudDays.FirstOrDefault(d => d.Date.Date == date.Date);
      if (newStatus == 0) { if (existing != null) cloudDays.Remove(existing); }
      else
      {
        if (existing != null) existing.StatusInt = newStatus;
        else cloudDays.Add(new DayEntry { Date = date.Date, StatusInt = newStatus });
      }
    }
    SelectedDates.Clear();
    StateHasChanged();
  }

  private async Task SyncDays()
  {
    if (!isAdmin) return;
    isSyncing = true;
    try
    {
      await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.NotEqual, "1900-01-01").Delete();
      if (cloudDays.Any()) await SupabaseClient.From<DayEntry>().Insert(cloudDays);
      syncMessage = "Синхронизирано!";
    }
    catch { syncMessage = "Грешка!"; }
    finally { isSyncing = false; StateHasChanged(); }
  }

  private string GetStatusClass(DateTime date) =>
      cloudDays.FirstOrDefault(d => d.Date.Date == date.Date)?.StatusInt switch
      {
        1 => "status-worked",
        2 => "status-paid",
        3 => "status-finished",
        4 => "status-onwork",
        _ => ""
      };
}