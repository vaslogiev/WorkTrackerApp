@page "/"
@using System.Globalization
@using Supabase
@using Postgrest.Attributes
@using Postgrest.Models
@inject Supabase.Client SupabaseClient

<div class="app-container">
  @* Показваме какво вижда софтуера за тест *@
  <div class="debug-info">
    Брой записи в базата: @cloudDays.Count
  </div>

  @if (isLoading)
  {
    <div class="loader">Зареждане...</div>
  }
  else
  {
    <div class="calendar-card">
      <div class="calendar-nav">
        <button @onclick="() => ChangeMonth(-1)">⬅</button>
        <span>@viewDate.ToString("MMMM yyyy", new CultureInfo("bg-BG"))</span>
        <button @onclick="() => ChangeMonth(1)">➡</button>
      </div>

      <div class="calendar-grid">
        @foreach (var day in new[] { "Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Нд" })
        {
          <div class="header">@day</div>
        }
        @for (int i = 0; i < OffsetDays; i++)
        {
          <div class="empty"></div>
        }
        @foreach (var date in MonthDates)
        {
          <div class="day @GetStatusClass(date) @(SelectedDates.Contains(date) ? "selected" : "")"
               @onclick="() => ToggleSelection(date)">
            @date.Day
          </div>
        }
      </div>
    </div>

    <div class="actions">
      <button class="btn-worked" @onclick="() => SetStatusForSelected(1)">Изработен</button>
      <button class="btn-paid" @onclick="() => SetStatusForSelected(2)">Платен</button>
      <button class="btn-done" @onclick="() => SetStatusForSelected(3)">Приключен</button>
      <button class="btn-clear" @onclick="() => SetStatusForSelected(0)">Изчисти</button>
    </div>

    <button class="btn-sync" @onclick="SyncData" disabled="@isSyncing">
      @(isSyncing ? "Синхронизиране..." : "ЗАПАЗИ В ОБЛАКА")
    </button>
    <p class="status-msg">@syncMessage</p>
  }
</div>

<style>
  /* Пълно унищожаване на навигацията */
  ::deep .sidebar, ::deep .top-row, .sidebar, .top-row {
    display: none !important;
  }

  .app-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 10px;
    font-family: sans-serif;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    text-align: center;
  }

  .day {
    padding: 10px 0;
    border: 1px solid #eee;
    border-radius: 5px;
    cursor: pointer;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .header {
    font-weight: bold;
    font-size: 0.8rem;
    padding-bottom: 5px;
  }

  .status-worked {
    background: #ffeb3b;
  }

  .status-paid {
    background: #4caf50;
    color: white;
  }

  .status-finished {
    background: #e0e0e0;
  }

  .selected {
    border: 2px solid #2196f3;
    box-shadow: 0 0 5px rgba(33,150,243,0.5);
  }

  .actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 20px 0;
  }

    .actions button {
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
    }

  .btn-worked {
    background: #ffeb3b;
  }

  .btn-paid {
    background: #4caf50;
    color: white;
  }

  .btn-done {
    background: #e0e0e0;
  }

  .btn-clear {
    background: #ff5252;
    color: white;
  }

  .btn-sync {
    width: 100%;
    padding: 15px;
    background: #2196f3;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
  }

  .debug-info {
    font-size: 0.7rem;
    color: #ccc;
    margin-bottom: 5px;
  }
</style>

@code {
  [Table("work_days")]
  public class DayEntry : BaseModel
  {
    [PrimaryKey("date", false)][Column("date")] public DateTime Date { get; set; }
    [Column("status")] public int StatusInt { get; set; }
  }

  private List<DayEntry> cloudDays = new();
  private HashSet<DateTime> SelectedDates = new();
  private List<DateTime> MonthDates = new();
  private DateTime viewDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
  private int OffsetDays;
  private bool isLoading = true, isSyncing = false;
  private string syncMessage = "";

  protected override async Task OnInitializedAsync() { await LoadDataFromCloud(); SetupCalendar(); }

  private void SetupCalendar()
  {
    MonthDates.Clear();
    OffsetDays = ((int)viewDate.DayOfWeek + 6) % 7;
    for (int i = 1; i <= DateTime.DaysInMonth(viewDate.Year, viewDate.Month); i++)
      MonthDates.Add(new DateTime(viewDate.Year, viewDate.Month, i));
  }

  private void ChangeMonth(int step) { viewDate = viewDate.AddMonths(step); SetupCalendar(); }

  private async Task LoadDataFromCloud()
  {
    isLoading = true;
    try
    {
      var response = await SupabaseClient.From<DayEntry>().Get();
      // ТУК Е МАГИЯТА: Добавяме +1 ден към всичко, което идва от базата
      cloudDays = response.Models.Select(d =>
      {
        d.Date = d.Date.AddDays(1).Date;
        return d;
      }).ToList();
    }
    catch { }
    finally { isLoading = false; StateHasChanged(); }
  }

  private void ToggleSelection(DateTime date)
  {
    if (!SelectedDates.Remove(date)) SelectedDates.Add(date);
  }

  private async Task SetStatusForSelected(int newStatus)
  {
    foreach (var date in SelectedDates)
    {
      var existing = cloudDays.FirstOrDefault(d => d.Date.Date == date.Date);
      if (newStatus == 0)
      {
        if (existing != null) cloudDays.Remove(existing);
      }
      else
      {
        if (existing != null) existing.StatusInt = newStatus;
        else cloudDays.Add(new DayEntry { Date = date.Date, StatusInt = newStatus });
      }
    }
    SelectedDates.Clear();
    StateHasChanged();
  }

  private async Task SyncData()
  {
    isSyncing = true;
    syncMessage = "Записване...";
    try
    {
      // Трием всичко и записваме наново - най-сигурният начин
      await SupabaseClient.From<DayEntry>().Filter("date", Postgrest.Constants.Operator.NotEqual, "1900-01-01").Delete();
      if (cloudDays.Any())
      {
        // Когато записваме, библиотеката автоматично ще свали 2 часа (т.е. ще стане -1 ден в базата)
        await SupabaseClient.From<DayEntry>().Insert(cloudDays);
      }
      syncMessage = "✅ Успех!";
    }
    catch { syncMessage = "❌ Грешка"; }
    finally { isSyncing = false; StateHasChanged(); }
  }

  private string GetStatusClass(DateTime date) =>
      cloudDays.FirstOrDefault(d => d.Date.Date == date.Date)?.StatusInt switch
      {
        1 => "status-worked",
        2 => "status-paid",
        3 => "status-finished",
        _ => ""
      };
}